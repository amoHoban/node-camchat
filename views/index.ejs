<!DOCTYPE html>
<html>
  <head>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script> 
  <script src="/socket.io/socket.io.js"></script>
	<title><%= title %></title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
  </head>
  <body>
    <h1>Hi <%= nickname %>, welcome to <%= title %></h1>
    <div id="textarea"></div>
	<div class="userinput">
		<form id="chatform" onsubmit="sendMessage(event)">
			<input type="text" size="200" id="msgbox" value="" />
			<input type="submit">
		</form>
	</div>
	<div id="frame">
	    <video id="live" width="280" height="210" autoplay style="display: none;"></video>
	    <canvas width="280" id="canvas" height="210" style="display: inline;"></canvas>
	</div>
	<img width="280" id="partnerCanvas" height="210" style="display: inline;" />
  	<script type="text/javascript">
  	$(document).ready(function(){
  	textarea = $("#textarea");
    msgbox = $("#msgbox");
    camWidth = 280;
    camHeight = 210;

    scrollDownText = function(){
      $("#textarea").scrollTop($("#textarea")[0].scrollHeight+20);
    };


    socket = io.connect();
    socket.on("connect",function(){
      socket.emit("set nickname","<%= nickname %>");
    })
    socket.on('message', function(message) {
      if (message instanceof Array) {
        $.each(message, function(index){
          showMessage("#textarea",message[index]);
        })
      } 
      else {
        showMessage("#textarea",message);

      }
      scrollDownText();
    });

    socket.on('webcam',function(object){
      $("#partnerCanvas").attr("src",object.img.img);
    });
    socket.on("newUser",function(data){
      console.log(data);
      $(textarea).append("<p class='alert'>User "+data+" joined</p>");
    })
    socket.on("user disconnected",function(user){
      $(textarea).append("<p class='alert'>User +"+user+" disconnected</p>");
    })



    
  	function changeSize(w){
  		camWidth = w;
  		camHeight = w * 0.75;

  		$("#video, #canvas, #partnerCanvas").height(camHeight).width(camWidth);
  		$("#video, #canvas").click(function(){
  			if (w==320) changeSize(640);
  			else changeSize(320);
  			});
  		};

    function removeSenderVideo(){
      $("#video, #canvas").remove();
    }

  	window.URL = window.URL || window.webkitURL;
	 navigator.getUserMedia  = (navigator.getUserMedia || navigator.webkitGetUserMedia ||
                          navigator.mozGetUserMedia || navigator.msGetUserMedia);
                          	
  	var video = $("#live").get()[0];
    var canvas = $("#canvas");
    var ctx = canvas.get()[0].getContext('2d');
 	  if (typeof navigator.getUserMedia== 'function') {
    navigator.getUserMedia({video:!0},function(stream) {video.src = window.URL.createObjectURL(stream);},
            function(err) {
                console.log("Unable to get video stream!")
            }
    )
	 
	 timer = setInterval(
        function () {
            ctx.drawImage(video, 0, 0, camWidth, camHeight);
            var data = canvas.get()[0].toDataURL('image/jpeg', 1.0);
            socket.emit("webcam",{"img":data});
    }, 250);

  	}
    else {
      removeSenderVideo();
    }
  	$(msgbox).focus();
  	$(textarea).height("63%");
  	$(textarea).width("90%");
  	$(window).resize(function(){
  		$(textarea).height("63%");
  		$(textarea).width("90%");
  	})
  	
  	showMessage = function(el, m){
  		line = $("<p/>").text(unescape(m)).hide();
		$(el).append(line);
		line.fadeIn();
  	}

  	
	
  	$(window).resize(function(){scrollDownText();})
  	sendMessage = function(event){
  		event.preventDefault();
  		socket.send($(msgbox).val(),function(){$(msgbox).val("")});
  		return false;
  	}; 
  });
  	</script>
  </body>
</html>